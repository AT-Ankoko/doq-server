INFO:     Will watch for changes in these directories: ['/Users/eunbee/Documents/GitHub/doq-server']
INFO:     Uvicorn running on http://0.0.0.0:9571 (Press CTRL+C to quit)
INFO:     Started reloader process [31308] using WatchFiles
+ start load cfg
- end load cfg
> loaded JSON map 'event_map' from src/service/conf/doq-event-map.cfg.json
CORS configuration complete: ['http://localhost:3000']
INFO:     Started server process [31315]
INFO:     Waiting for application startup.
+ start load cfg
- end load cfg
> loaded JSON map 'event_map' from src/service/conf/doq-event-map.cfg.json
CORS configuration complete: ['http://localhost:3000']
+ start load cfg
- end load cfg
> loaded JSON map 'event_map' from src/service/conf/doq-event-map.cfg.json
CORS configuration complete: ['http://localhost:3000']
     - Initializing application...
     - Initializing handlers...
+ start init logger
12/07 18:37:56.067 DEBUG    - end init logger
12/07 18:37:56.068 INFO     ===FILE LOG TEST START===
12/07 18:37:56.068 DEBUG       -test debug level
12/07 18:37:56.068 INFO        -test info level
12/07 18:37:56.068 WARNING     -test warn level
12/07 18:37:56.068 ERROR       -test error level
12/07 18:37:56.068 INFO     ===FILE LOG TEST END===
12/07 18:37:56.068 DEBUG    + start init system manager
12/07 18:37:56.068 DEBUG    SYSTEM STATS - Memory 92.05MB (1.12%), CPU: 0.00%, Threads: 2, FDs: 12
12/07 18:37:56.068 INFO     [Manager]   -- System monitor started (interval: 10s)
12/07 18:37:56.068 DEBUG    - end init system manager
12/07 18:37:56.068 INFO          - Initializing handlers...
12/07 18:37:56.069 DEBUG    + start init websocket
12/07 18:37:56.069 DEBUG    - end init websocket
12/07 18:37:56.069 DEBUG    + start init Redis
12/07 18:37:56.069 DEBUG    - end init Redis
12/07 18:37:56.069 DEBUG    + start init RedisStreamConsumer
12/07 18:37:56.069 DEBUG    - end init RedisStreamConsumer
     - Initializing algorithms...
12/07 18:37:56.069 DEBUG    + start init LLMs
12/07 18:37:56.069 INFO     [LLM] manager ready (model=gemini-2.0-flash)
12/07 18:37:56.069 DEBUG    [REDIS]      - Connecting...
12/07 18:37:56.082 INFO     [REDIS]      == Connected
12/07 18:37:56.082 INFO     [REDIS]     - Consumer group 'web-group' already exists
12/07 18:37:56.083 INFO     [REDIS]     - Redis consumer starting: group=web-group, stream=session:chat:*, consumer=web-consumer-1
12/07 18:37:56.083 INFO          == Initialization complete
INFO:     Application startup complete.
INFO:     127.0.0.1:64433 - "WebSocket /v1/session/chat?sid=reproduce_repetition_test_001" [accepted]
12/07 18:38:04.716 INFO     [WS]        - Connected: ID=reproduce_repetition_test_001, Client=Address(host='127.0.0.1', port=64433)
INFO:     connection open
12/07 18:38:04.731 DEBUG    [REDIS]     ++ XADD session:chat:reproduce_repetition_test_001 > 1765100284726-0, {'participant': 'assistant', 'body': '{"hd":{"sid":"reproduce_repetition_test_001","event":"llm.response","role":"assistant","asker":null,"step":"introduction","user_name":"의뢰인","role_name":"client","contract_date":null},"bd":{"text":"\\n안녕하세요, 용역 계약서 작성을 도와드릴 DoQ입니다.  \\n양측 조건을 바탕으로 공정하고 명확한 계약서를 함께 만들어가겠습니다.\\n\\n현재 이해한 내용은 다음과 같습니다\\n- 의뢰인: 의뢰인\\n- 용역자: 용역자\\n\\n작업 범위, 기간, 대금 등을 순차적으로 확인하겠습니다.\\n\\n먼저 질문드릴게요: \\n의뢰인님, 어떤 용역을 의뢰하실 계획인가요?  \\n예: \\"브랜딩 로고 디자인\\", \\"웹 UI 디자인\\", \\"영상 편집 2건\\" 등\\n","contract_draft":null,"state":{"code":"S0000","msg":"성공"}},"sid":"reproduce_repetition_test_001"}'}
12/07 18:38:04.731 DEBUG    [WS]        ++ Chat saved to stream session:chat:reproduce_repetition_test_001 > 1765100284726-0
12/07 18:38:04.732 DEBUG    [WS]        >> Received message: {'hd': {'event': 'chat.message', 'role': 'client', 'timestamp': '2025-12-07T18:38:04.718855'}, 'bd': {'text': '안녕하세요. 계약서 작성을 시작하고 싶습니다.'}}
12/07 18:38:04.732 DEBUG    [WS] - Event map keys: ['doq_be']
12/07 18:38:04.732 DEBUG    [WS] - Project 'doq_be', source_type 'ws' events: ['chat.message', 'llm.invoke', 'typing']
12/07 18:38:04.735 DEBUG    [WS] - Dispatching to handler: src.service.ai.chat_ws.handle_llm_invocation
12/07 18:38:04.735 INFO     [WS]        -- LLM invocation (asker=client) in session reproduce_repetition_test_001
12/07 18:38:04.735 DEBUG    [WS]        -- Message: {'hd': {'event': 'chat.message', 'role': 'client', 'timestamp': '2025-12-07T18:38:04.718855', 'asker': 'client', 'sid': 'reproduce_repetition_test_001'}, 'bd': {'text': '안녕하세요. 계약서 작성을 시작하고 싶습니다.'}, 'sid': 'reproduce_repetition_test_001'}
12/07 18:38:04.736 DEBUG    [REDIS]     == GET session:chat_state:reproduce_repetition_test_001 > None
12/07 18:38:04.736 DEBUG    [REDIS]     !! SET session:chat_state:reproduce_repetition_test_001 = {"sid":"reproduce_repetition_test_001","user_info":{"user_name":"client","role":"client","contract_date":null},"current_step":"introduction","step_history":["introduction"],"collected_data":{"client_name":null,"client_company":null,"provider_name":null,"provider_company":null,"category":null,"work_scope":null,"work_period":null,"start_date":null,"end_date":null,"budget":null,"revision_count":null,"copyright_owner":null,"confidentiality_terms":null,"special_conditions":null},"role_inputs":{"client":[],"provider":[]},"conflicts":[],"created_at":"2025-12-07T18:38:04.736497","updated_at":"2025-12-07T18:38:04.736504","progress_percentage":0.0} (expire: None)
12/07 18:38:04.736 INFO     [WS]        -- New session state created for reproduce_repetition_test_001, user: client (client)
12/07 18:38:04.752 DEBUG    [REDIS]     ++ XADD session:chat:reproduce_repetition_test_001 > 1765100284751-0, {'participant': 'client', 'body': '{"hd":{"sid":"reproduce_repetition_test_001","event":"chat.message","role":"client"},"bd":{"text":"안녕하세요. 계약서 작성을 시작하고 싶습니다."}}'}
12/07 18:38:04.752 DEBUG    [WS]        ++ Chat saved to stream session:chat:reproduce_repetition_test_001 > 1765100284751-0
12/07 18:38:04.753 INFO     [WS]        -- Chat history loaded: 2 messages
12/07 18:38:04.753 DEBUG    [WS]        -- History preview: ['client(의뢰인(갑)): 안녕하세요. 계약서 작성을 시작하고 싶습니다.', 'assistant: \n안녕하세요, 용역 계약서 작성을 도와드릴 DoQ입니다.  \n양측 조건을 바탕으로 공정하고 명확한 계약서를 함께 만들어가겠습니다.\n\n현재 이해한 내용은 다음과 같습니다\n- 의뢰인: 의뢰인\n- 용역자: 용역자\n\n작업 범위, 기간, 대금 등을 순차적으로 확인하겠습니다.\n\n먼저 질문드릴게요: \n의뢰인님, 어떤 용역을 의뢰하실 계획인가요?  \n예: "브랜딩 로고 디자인", "웹 UI 디자인", "영상 편집 2건" 등\n']
12/07 18:38:06.075 DEBUG    SYSTEM STATS - Memory 56.80MB (0.69%), CPU: 0.80%, Threads: 14, FDs: 22
12/07 18:38:09.445 INFO     [WS]        -- Step advance decision: False, reason=아직 의뢰인이 어떤 용역을 의뢰할 계획인지 응답하지 않았으므로 다음 단계로 진행하기 어렵습니다.
12/07 18:38:09.445 INFO     [WS]        -- Auto-advance from introduction due to user input
12/07 18:38:09.445 INFO     [WS]        -- Auto-saved user input from introduction to work_scope: 안녕하세요. 계약서 작성을 시작하고 싶습니다....
12/07 18:38:09.446 DEBUG    [REDIS]     !! SET session:chat_state:reproduce_repetition_test_001 = {"sid":"reproduce_repetition_test_001","user_info":{"user_name":"client","role":"client","contract_date":null},"current_step":"work_scope","step_history":["introduction","work_scope"],"collected_data":{"client_name":null,"client_company":null,"provider_name":null,"provider_company":null,"category":null,"work_scope":"안녕하세요. 계약서 작성을 시작하고 싶습니다.","work_period":null,"start_date":null,"end_date":null,"budget":null,"revision_count":null,"copyright_owner":null,"confidentiality_terms":null,"special_conditions":null},"role_inputs":{"client":[{"text":"안녕하세요. 계약서 작성을 시작하고 싶습니다.","timestamp":"2025-12-07T18:38:04.736729","step":"introduction"}],"provider":[]},"conflicts":[],"created_at":"2025-12-07T18:38:04.736497","updated_at":"2025-12-07T18:38:09.446052","progress_percentage":10.0} (expire: None)
12/07 18:38:09.446 INFO     [WS]        -- User confirmed, moved to next step: work_scope
12/07 18:38:09.447 DEBUG    [REDIS]     ++ XADD session:chat:reproduce_repetition_test_001 > 1765100289447-0, {'participant': 'assistant', 'body': '{"hd":{"sid":"reproduce_repetition_test_001","event":"llm.response","role":"assistant","asker":"client","step":"work_scope","user_name":"client","role_name":"client","contract_date":null},"bd":{"text":"다음 단계로 이동합니다. (현재: work_scope, 진행률: 10.0%)","state":{"code":"S0000","msg":"성공"}},"sid":"reproduce_repetition_test_001"}'}
12/07 18:38:09.447 DEBUG    [WS]        ++ Chat saved to stream session:chat:reproduce_repetition_test_001 > 1765100289447-0
12/07 18:38:09.448 INFO     [WS]        -- Collected data: {"client_name":null,"client_company":null,"provider_name":null,"provider_company":null,"category":null,"work_scope":"안녕하세요. 계약서 작성을 시작하고 싶습니다.","work_
12/07 18:38:11.793 DEBUG    [REDIS]     ++ XADD session:chat:reproduce_repetition_test_001 > 1765100291793-0, {'participant': 'assistant', 'body': '{"hd":{"sid":"reproduce_repetition_test_001","event":"llm.response","role":"assistant","asker":"client","step":"work_scope","user_name":"client","role_name":"client","contract_date":null},"bd":{"text":"안녕하세요, 갑(client)님. 계약서 작성을 계속 진행하겠습니다. 우선 용역 기간은 어떻게 설정하면 좋을까요? 시작일과 종료일을 알려주세요.","contract_draft":"용역계약서(초안)\\n\\n1. 계약 당사자\\n   - 갑(의뢰인): client\\n   - 을(용역자): 미기재\\n\\n2. 용역 내용\\n   - 작업 범위: 미기재\\n   - 작업 내용: 미기재\\n\\n3. 계약 금액\\n   - 총 금액: 미기재\\n   - 지급 방식: 미기재\\n\\n4. 용역 기간\\n   - 시작일: 미기재\\n   - 종료일: 미기재\\n\\n5. 저작권 귀속\\n   - 저작권 귀속 주체: 미기재\\n\\n6. 수정 횟수\\n   - 수정 가능 횟수: 미기재\\n\\n7. 기타 조건\\n   - 미기재","current_step":"work_scope","progress_percentage":10.0,"state":{"code":"S0000","msg":"성공"}},"sid":"reproduce_repetition_test_001"}'}
12/07 18:38:11.794 DEBUG    [WS]        ++ Chat saved to stream session:chat:reproduce_repetition_test_001 > 1765100291793-0
12/07 18:38:11.794 INFO     [WS]        -- LLM response sent (step: work_scope, status: OK)
12/07 18:38:11.794 DEBUG    [REDIS]     !! SET session:chat_state:reproduce_repetition_test_001 = {"sid":"reproduce_repetition_test_001","user_info":{"user_name":"client","role":"client","contract_date":null},"current_step":"work_scope","step_history":["introduction","work_scope"],"collected_data":{"client_name":null,"client_company":null,"provider_name":null,"provider_company":null,"category":null,"work_scope":"안녕하세요. 계약서 작성을 시작하고 싶습니다.","work_period":null,"start_date":null,"end_date":null,"budget":null,"revision_count":null,"copyright_owner":null,"confidentiality_terms":null,"special_conditions":null},"role_inputs":{"client":[{"text":"안녕하세요. 계약서 작성을 시작하고 싶습니다.","timestamp":"2025-12-07T18:38:04.736729","step":"introduction"}],"provider":[]},"conflicts":[],"created_at":"2025-12-07T18:38:04.736497","updated_at":"2025-12-07T18:38:09.446052","progress_percentage":10.0} (expire: None)
12/07 18:38:11.794 DEBUG    [WS]        >> Received message: {'hd': {'event': 'chat.llm', 'role': 'client', 'timestamp': '2025-12-07T18:38:04.718956'}, 'bd': {}}
12/07 18:38:11.795 DEBUG    [WS] - Event map keys: ['doq_be']
12/07 18:38:11.795 DEBUG    [WS] - Project 'doq_be', source_type 'ws' events: ['chat.message', 'llm.invoke', 'typing']
12/07 18:38:11.795 WARNING  [WS] - No handler for event 'chat.llm'
12/07 18:38:11.795 DEBUG    [WS] - Available events: ['chat.message', 'llm.invoke', 'typing']
12/07 18:38:11.795 DEBUG    [WS]        << Send response: {'status': 'error', 'msg': 'No handler for event: chat.llm'}
12/07 18:38:16.078 DEBUG    SYSTEM STATS - Memory 23.97MB (0.29%), CPU: 0.80%, Threads: 15, FDs: 20
12/07 18:38:26.085 DEBUG    SYSTEM STATS - Memory 27.70MB (0.34%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:38:36.092 DEBUG    SYSTEM STATS - Memory 22.53MB (0.28%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:38:46.098 DEBUG    SYSTEM STATS - Memory 24.20MB (0.30%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:38:56.109 DEBUG    SYSTEM STATS - Memory 22.69MB (0.28%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:39:06.119 DEBUG    SYSTEM STATS - Memory 18.97MB (0.23%), CPU: 0.50%, Threads: 15, FDs: 20
12/07 18:39:16.127 DEBUG    SYSTEM STATS - Memory 14.33MB (0.18%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:39:26.133 DEBUG    SYSTEM STATS - Memory 13.22MB (0.16%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:39:36.139 DEBUG    SYSTEM STATS - Memory 11.27MB (0.14%), CPU: 0.30%, Threads: 15, FDs: 20
12/07 18:39:46.147 DEBUG    SYSTEM STATS - Memory 13.75MB (0.17%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:39:56.151 DEBUG    SYSTEM STATS - Memory 15.19MB (0.19%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:40:06.158 DEBUG    SYSTEM STATS - Memory 13.62MB (0.17%), CPU: 0.50%, Threads: 15, FDs: 20
12/07 18:40:16.165 DEBUG    SYSTEM STATS - Memory 13.11MB (0.16%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:40:26.172 DEBUG    SYSTEM STATS - Memory 14.97MB (0.18%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:40:36.176 DEBUG    SYSTEM STATS - Memory 15.12MB (0.18%), CPU: 0.50%, Threads: 15, FDs: 20
12/07 18:40:46.182 DEBUG    SYSTEM STATS - Memory 15.20MB (0.19%), CPU: 0.50%, Threads: 15, FDs: 20
12/07 18:40:56.183 DEBUG    SYSTEM STATS - Memory 15.23MB (0.19%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:41:06.190 DEBUG    SYSTEM STATS - Memory 15.08MB (0.18%), CPU: 0.50%, Threads: 15, FDs: 20
12/07 18:41:16.195 DEBUG    SYSTEM STATS - Memory 15.41MB (0.19%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:41:26.199 DEBUG    SYSTEM STATS - Memory 15.44MB (0.19%), CPU: 0.50%, Threads: 15, FDs: 20
12/07 18:41:36.205 DEBUG    SYSTEM STATS - Memory 13.58MB (0.17%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:41:46.212 DEBUG    SYSTEM STATS - Memory 15.19MB (0.19%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:41:56.217 DEBUG    SYSTEM STATS - Memory 15.34MB (0.19%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:42:06.221 DEBUG    SYSTEM STATS - Memory 12.02MB (0.15%), CPU: 0.40%, Threads: 15, FDs: 20
12/07 18:42:16.223 DEBUG    SYSTEM STATS - Memory 16.66MB (0.20%), CPU: 0.50%, Threads: 15, FDs: 20
12/07 18:42:26.229 DEBUG    SYSTEM STATS - Memory 15.52MB (0.19%), CPU: 0.40%, Threads: 15, FDs: 19
12/07 18:42:36.236 DEBUG    SYSTEM STATS - Memory 13.53MB (0.17%), CPU: 0.40%, Threads: 15, FDs: 19
12/07 18:42:46.243 DEBUG    SYSTEM STATS - Memory 13.98MB (0.17%), CPU: 0.40%, Threads: 15, FDs: 19
12/07 18:42:46.947 INFO     [WS]        - Disconnected: Client=Address(host='127.0.0.1', port=64433)
INFO:     connection closed
12/07 18:42:56.251 DEBUG    SYSTEM STATS - Memory 9.30MB (0.11%), CPU: 0.40%, Threads: 15, FDs: 18
12/07 18:43:06.259 DEBUG    SYSTEM STATS - Memory 11.77MB (0.14%), CPU: 0.40%, Threads: 15, FDs: 18
12/07 18:43:16.264 DEBUG    SYSTEM STATS - Memory 11.59MB (0.14%), CPU: 0.40%, Threads: 15, FDs: 18
12/07 18:43:26.271 DEBUG    SYSTEM STATS - Memory 11.50MB (0.14%), CPU: 0.40%, Threads: 15, FDs: 18
WARNING:  WatchFiles detected changes in 'test/reproduce_repetition.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
12/07 18:43:30.816 INFO          - Starting graceful shutdown
12/07 18:43:30.816 INFO          -- Shutting down application
12/07 18:43:30.816 WARNING       - RedisStreamConsumer stop failed: 'RedisStreamConsumer' object has no attribute '_consume_task'
12/07 18:43:30.816 DEBUG    [REDIS]       - Disconnecting...
12/07 18:43:30.818 ERROR    [REDIS]     !! Error while consuming stream: Connection closed by server.
12/07 18:43:30.819 WARNING  [REDIS]     >> Detected closed buffer. Attempting reconnect...
12/07 18:43:30.819 INFO     [REDIS]      -- Reconnecting to Redis...
12/07 18:43:30.820 DEBUG    [REDIS]       - Disconnecting...
12/07 18:43:30.820 INFO     [REDIS]       -- Disconnected
12/07 18:43:30.820 INFO          -- Redis handler closed
12/07 18:43:30.820 INFO     [WS]        - Disconnecting all clients...
12/07 18:43:30.820 INFO          -- WebSocket handler closed
12/07 18:43:35.827 INFO     [Manager]   -- system monitor stopped
12/07 18:43:35.829 INFO          -- system monitor stopped
12/07 18:43:35.830 INFO     [REDIS]       -- Disconnected
INFO:     Application shutdown complete.
INFO:     Finished server process [31315]
WARNING:  WatchFiles detected changes in 'test/reproduce_repetition.py'. Reloading...
INFO:     Started server process [32664]
INFO:     Waiting for application startup.
+ start load cfg
- end load cfg
> loaded JSON map 'event_map' from src/service/conf/doq-event-map.cfg.json
CORS configuration complete: ['http://localhost:3000']
+ start load cfg
- end load cfg
> loaded JSON map 'event_map' from src/service/conf/doq-event-map.cfg.json
CORS configuration complete: ['http://localhost:3000']
     - Initializing application...
     - Initializing handlers...
+ start init logger
12/07 18:43:37.055 DEBUG    - end init logger
12/07 18:43:37.055 INFO     ===FILE LOG TEST START===
12/07 18:43:37.055 DEBUG       -test debug level
12/07 18:43:37.055 INFO        -test info level
12/07 18:43:37.055 WARNING     -test warn level
12/07 18:43:37.055 ERROR       -test error level
12/07 18:43:37.055 INFO     ===FILE LOG TEST END===
12/07 18:43:37.055 DEBUG    + start init system manager
12/07 18:43:37.055 DEBUG    SYSTEM STATS - Memory 92.89MB (1.13%), CPU: 0.00%, Threads: 2, FDs: 12
12/07 18:43:37.056 INFO     [Manager]   -- System monitor started (interval: 10s)
12/07 18:43:37.056 DEBUG    - end init system manager
12/07 18:43:37.056 INFO          - Initializing handlers...
12/07 18:43:37.056 DEBUG    + start init websocket
12/07 18:43:37.056 DEBUG    - end init websocket
12/07 18:43:37.056 DEBUG    + start init Redis
12/07 18:43:37.056 DEBUG    - end init Redis
12/07 18:43:37.056 DEBUG    + start init RedisStreamConsumer
12/07 18:43:37.056 DEBUG    - end init RedisStreamConsumer
     - Initializing algorithms...
12/07 18:43:37.056 DEBUG    + start init LLMs
12/07 18:43:37.056 INFO     [LLM] manager ready (model=gemini-2.0-flash)
12/07 18:43:37.056 DEBUG    [REDIS]      - Connecting...
12/07 18:43:37.064 INFO     [REDIS]      == Connected
12/07 18:43:37.068 INFO     [REDIS]     - Consumer group 'web-group' already exists
12/07 18:43:37.068 INFO     [REDIS]     - Redis consumer starting: group=web-group, stream=session:chat:*, consumer=web-consumer-1
12/07 18:43:37.068 INFO          == Initialization complete
INFO:     Application startup complete.
WARNING:  WatchFiles detected changes in 'test/reproduce_repetition.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
12/07 18:43:41.314 INFO          - Starting graceful shutdown
12/07 18:43:41.314 INFO          -- Shutting down application
12/07 18:43:41.314 WARNING       - RedisStreamConsumer stop failed: 'RedisStreamConsumer' object has no attribute '_consume_task'
12/07 18:43:41.315 DEBUG    [REDIS]       - Disconnecting...
12/07 18:43:41.315 ERROR    [REDIS]     !! Error while consuming stream: Connection closed by server.
12/07 18:43:41.315 WARNING  [REDIS]     >> Detected closed buffer. Attempting reconnect...
12/07 18:43:41.315 INFO     [REDIS]      -- Reconnecting to Redis...
12/07 18:43:41.315 DEBUG    [REDIS]       - Disconnecting...
12/07 18:43:41.315 INFO     [REDIS]       -- Disconnected
12/07 18:43:41.315 INFO          -- Redis handler closed
12/07 18:43:41.315 INFO     [WS]        - Disconnecting all clients...
12/07 18:43:41.315 INFO          -- WebSocket handler closed
12/07 18:43:46.321 INFO     [Manager]   -- system monitor stopped
12/07 18:43:46.322 INFO          -- system monitor stopped
12/07 18:43:46.323 INFO     [REDIS]       -- Disconnected
INFO:     Application shutdown complete.
INFO:     Finished server process [32664]
WARNING:  WatchFiles detected changes in 'test/reproduce_repetition.py'. Reloading...
INFO:     Started server process [32762]
INFO:     Waiting for application startup.
+ start load cfg
- end load cfg
> loaded JSON map 'event_map' from src/service/conf/doq-event-map.cfg.json
CORS configuration complete: ['http://localhost:3000']
+ start load cfg
- end load cfg
> loaded JSON map 'event_map' from src/service/conf/doq-event-map.cfg.json
CORS configuration complete: ['http://localhost:3000']
     - Initializing application...
     - Initializing handlers...
+ start init logger
12/07 18:43:47.428 DEBUG    - end init logger
12/07 18:43:47.428 INFO     ===FILE LOG TEST START===
12/07 18:43:47.428 DEBUG       -test debug level
12/07 18:43:47.428 INFO        -test info level
12/07 18:43:47.428 WARNING     -test warn level
12/07 18:43:47.428 ERROR       -test error level
12/07 18:43:47.428 INFO     ===FILE LOG TEST END===
12/07 18:43:47.428 DEBUG    + start init system manager
12/07 18:43:47.428 DEBUG    SYSTEM STATS - Memory 89.88MB (1.10%), CPU: 0.00%, Threads: 2, FDs: 12
12/07 18:43:47.428 INFO     [Manager]   -- System monitor started (interval: 10s)
12/07 18:43:47.428 DEBUG    - end init system manager
12/07 18:43:47.428 INFO          - Initializing handlers...
12/07 18:43:47.428 DEBUG    + start init websocket
12/07 18:43:47.428 DEBUG    - end init websocket
12/07 18:43:47.428 DEBUG    + start init Redis
12/07 18:43:47.428 DEBUG    - end init Redis
12/07 18:43:47.428 DEBUG    + start init RedisStreamConsumer
12/07 18:43:47.428 DEBUG    - end init RedisStreamConsumer
     - Initializing algorithms...
12/07 18:43:47.428 DEBUG    + start init LLMs
12/07 18:43:47.428 INFO     [LLM] manager ready (model=gemini-2.0-flash)
12/07 18:43:47.428 DEBUG    [REDIS]      - Connecting...
12/07 18:43:47.432 INFO     [REDIS]      == Connected
12/07 18:43:47.432 INFO     [REDIS]     - Consumer group 'web-group' already exists
12/07 18:43:47.432 INFO     [REDIS]     - Redis consumer starting: group=web-group, stream=session:chat:*, consumer=web-consumer-1
12/07 18:43:47.432 INFO          == Initialization complete
INFO:     Application startup complete.
12/07 18:43:57.435 DEBUG    SYSTEM STATS - Memory 25.34MB (0.31%), CPU: 0.30%, Threads: 3, FDs: 15
12/07 18:44:07.441 DEBUG    SYSTEM STATS - Memory 10.45MB (0.13%), CPU: 0.30%, Threads: 3, FDs: 15
12/07 18:44:17.444 DEBUG    SYSTEM STATS - Memory 9.72MB (0.12%), CPU: 0.30%, Threads: 3, FDs: 15
12/07 18:44:27.456 DEBUG    SYSTEM STATS - Memory 9.72MB (0.12%), CPU: 0.30%, Threads: 3, FDs: 15
12/07 18:44:37.464 DEBUG    SYSTEM STATS - Memory 9.78MB (0.12%), CPU: 0.30%, Threads: 3, FDs: 15
12/07 18:44:47.472 DEBUG    SYSTEM STATS - Memory 9.62MB (0.12%), CPU: 0.30%, Threads: 3, FDs: 15
12/07 18:44:57.479 DEBUG    SYSTEM STATS - Memory 9.66MB (0.12%), CPU: 0.30%, Threads: 3, FDs: 15
12/07 18:45:07.486 DEBUG    SYSTEM STATS - Memory 11.66MB (0.14%), CPU: 0.30%, Threads: 3, FDs: 15
12/07 18:45:17.493 DEBUG    SYSTEM STATS - Memory 9.08MB (0.11%), CPU: 0.40%, Threads: 3, FDs: 15
INFO:     127.0.0.1:64605 - "WebSocket /v1/session/chat?sid=reproduce_repetition_test_001" [accepted]
12/07 18:45:18.899 INFO     [WS]        - Connected: ID=reproduce_repetition_test_001, Client=Address(host='127.0.0.1', port=64605)
INFO:     connection open
12/07 18:45:18.908 DEBUG    [REDIS]     ++ XADD session:chat:reproduce_repetition_test_001 > 1765100718905-0, {'participant': 'assistant', 'body': '{"hd":{"sid":"reproduce_repetition_test_001","event":"llm.response","role":"assistant","asker":null,"step":"introduction","user_name":"의뢰인","role_name":"client","contract_date":null},"bd":{"text":"\\n안녕하세요, 용역 계약서 작성을 도와드릴 DoQ입니다.  \\n양측 조건을 바탕으로 공정하고 명확한 계약서를 함께 만들어가겠습니다.\\n\\n현재 이해한 내용은 다음과 같습니다\\n- 의뢰인: 의뢰인\\n- 용역자: 용역자\\n\\n작업 범위, 기간, 대금 등을 순차적으로 확인하겠습니다.\\n\\n먼저 질문드릴게요: \\n의뢰인님, 어떤 용역을 의뢰하실 계획인가요?  \\n예: \\"브랜딩 로고 디자인\\", \\"웹 UI 디자인\\", \\"영상 편집 2건\\" 등\\n","contract_draft":null,"state":{"code":"S0000","msg":"성공"}},"sid":"reproduce_repetition_test_001"}'}
12/07 18:45:18.908 DEBUG    [WS]        ++ Chat saved to stream session:chat:reproduce_repetition_test_001 > 1765100718905-0
12/07 18:45:18.909 DEBUG    [WS]        >> Received message: {'hd': {'event': 'chat.message', 'role': 'client', 'timestamp': '2025-12-07T18:45:18.900644'}, 'bd': {'text': '안녕하세요. 계약서 작성을 시작하고 싶습니다.'}}
12/07 18:45:18.909 DEBUG    [WS] - Event map keys: ['doq_be']
12/07 18:45:18.909 DEBUG    [WS] - Project 'doq_be', source_type 'ws' events: ['chat.message', 'llm.invoke', 'typing']
12/07 18:45:18.910 DEBUG    [WS] - Dispatching to handler: src.service.ai.chat_ws.handle_llm_invocation
12/07 18:45:18.910 INFO     [WS]        -- LLM invocation (asker=client) in session reproduce_repetition_test_001
12/07 18:45:18.910 DEBUG    [WS]        -- Message: {'hd': {'event': 'chat.message', 'role': 'client', 'timestamp': '2025-12-07T18:45:18.900644', 'asker': 'client', 'sid': 'reproduce_repetition_test_001'}, 'bd': {'text': '안녕하세요. 계약서 작성을 시작하고 싶습니다.'}, 'sid': 'reproduce_repetition_test_001'}
12/07 18:45:18.911 DEBUG    [REDIS]     == GET session:chat_state:reproduce_repetition_test_001 > {"sid":"reproduce_repetition_test_001","user_info":{"user_name":"client","role":"client","contract_date":null},"current_step":"work_scope","step_history":["introduction","work_scope"],"collected_data":{"client_name":null,"client_company":null,"provider_name":null,"provider_company":null,"category":null,"work_scope":"안녕하세요. 계약서 작성을 시작하고 싶습니다.","work_period":null,"start_date":null,"end_date":null,"budget":null,"revision_count":null,"copyright_owner":null,"confidentiality_terms":null,"special_conditions":null},"role_inputs":{"client":[{"text":"안녕하세요. 계약서 작성을 시작하고 싶습니다.","timestamp":"2025-12-07T18:38:04.736729","step":"introduction"}],"provider":[]},"conflicts":[],"created_at":"2025-12-07T18:38:04.736497","updated_at":"2025-12-07T18:38:09.446052","progress_percentage":10.0}
12/07 18:45:18.911 DEBUG    [WS]        -- Loaded session state for reproduce_repetition_test_001, current_step: work_scope
12/07 18:45:18.911 DEBUG    [REDIS]     ++ XADD session:chat:reproduce_repetition_test_001 > 1765100718911-0, {'participant': 'client', 'body': '{"hd":{"sid":"reproduce_repetition_test_001","event":"chat.message","role":"client"},"bd":{"text":"안녕하세요. 계약서 작성을 시작하고 싶습니다."}}'}
12/07 18:45:18.911 DEBUG    [WS]        ++ Chat saved to stream session:chat:reproduce_repetition_test_001 > 1765100718911-0
12/07 18:45:18.912 INFO     [WS]        -- Chat history loaded: 6 messages
12/07 18:45:18.912 DEBUG    [WS]        -- History preview: ['assistant: 다음 단계로 이동합니다. (현재: work_scope, 진행률: 10.0%)', 'client(의뢰인(갑)): 안녕하세요. 계약서 작성을 시작하고 싶습니다.', 'assistant: \n안녕하세요, 용역 계약서 작성을 도와드릴 DoQ입니다.  \n양측 조건을 바탕으로 공정하고 명확한 계약서를 함께 만들어가겠습니다.\n\n현재 이해한 내용은 다음과 같습니다\n- 의뢰인: 의뢰인\n- 용역자: 용역자\n\n작업 범위, 기간, 대금 등을 순차적으로 확인하겠습니다.\n\n먼저 질문드릴게요: \n의뢰인님, 어떤 용역을 의뢰하실 계획인가요?  \n예: "브랜딩 로고 디자인", "웹 UI 디자인", "영상 편집 2건" 등\n']
12/07 18:45:20.400 INFO     [WS]        -- Step advance decision: False, reason=사용자가 계약서 작성을 시작하고 싶다고만 언급했을 뿐, 어떤 용역을 의뢰할 계획인지 구체적으로 밝히지 않았습니다. 작업 범위를 특정해야 다음 단계로 진행할 수 있습니다.
12/07 18:45:26.702 DEBUG    [LLM] Response classification result: {'is_complete': True, 'extracted_data': {'work_scope': '웹사이트 디자인 및 퍼블리싱 (총 5페이지)', 'work_period': None, 'budget': None, 'revisions': None, 'copyright': None, 'confidentiality': None}, 'confidence': 0.95, 'next_action': 'proceed', 'clarification_needed': None, 'extracted_fields': {'work_scope': '웹사이트 디자인 및 퍼블리싱', 'page_count': '5'}}
12/07 18:45:26.704 DEBUG    [WS]        -- Response classification: {'is_complete': True, 'extracted_data': {'work_scope': '웹사이트 디자인 및 퍼블리싱 (총 5페이지)', 'work_period': None, 'budget': None, 'revisions': None, 'copyright': None, 'confidentiality': None}, 'confidence': 0.95, 'next_action': 'proceed', 'clarification_needed': None, 'extracted_fields': {'work_scope': '웹사이트 디자인 및 퍼블리싱', 'page_count': '5'}}
12/07 18:45:26.704 INFO     [WS]        -- Extracted fields saved: {'work_scope': '웹사이트 디자인 및 퍼블리싱', 'page_count': '5'}
12/07 18:45:26.705 INFO     [WS]        -- Collected data: {"client_name":null,"client_company":null,"provider_name":null,"provider_company":null,"category":null,"work_scope":"웹사이트 디자인 및 퍼블리싱","work_period":nu
12/07 18:45:27.500 DEBUG    SYSTEM STATS - Memory 33.98MB (0.41%), CPU: 1.00%, Threads: 15, FDs: 22
12/07 18:45:28.519 DEBUG    [REDIS]     ++ XADD session:chat:reproduce_repetition_test_001 > 1765100728518-0, {'participant': 'assistant', 'body': '{"hd":{"sid":"reproduce_repetition_test_001","event":"llm.response","role":"assistant","asker":"client","step":"work_scope","user_name":"client","role_name":"client","contract_date":null},"bd":{"text":"안녕하세요, 갑(client)님. 용역 계약서 작성을 시작하겠습니다. 먼저, 이번 용역의 **총 작업 기간**은 어느 정도로 예상하시나요? (예: 2023년 12월 25일부터 2024년 1월 24일까지)","contract_draft":"용역계약서 초안:\\n\\n1. 용역의 내용: 미기재\\n2. 계약 기간: 미기재\\n3. 용역 대금: 미기재\\n4. 저작권 귀속: 미기재\\n5. 수정 횟수: 미기재","current_step":"work_scope","progress_percentage":10.0,"state":{"code":"S0000","msg":"성공"}},"sid":"reproduce_repetition_test_001"}'}
12/07 18:45:28.520 DEBUG    [WS]        ++ Chat saved to stream session:chat:reproduce_repetition_test_001 > 1765100728518-0
12/07 18:45:28.520 INFO     [WS]        -- LLM response sent (step: work_scope, status: OK)
12/07 18:45:28.523 DEBUG    [REDIS]     !! SET session:chat_state:reproduce_repetition_test_001 = {"sid":"reproduce_repetition_test_001","user_info":{"user_name":"client","role":"client","contract_date":null},"current_step":"work_scope","step_history":["introduction","work_scope"],"collected_data":{"client_name":null,"client_company":null,"provider_name":null,"provider_company":null,"category":null,"work_scope":"웹사이트 디자인 및 퍼블리싱","work_period":null,"start_date":null,"end_date":null,"budget":null,"revision_count":null,"copyright_owner":null,"confidentiality_terms":null,"special_conditions":null},"role_inputs":{"client":[{"text":"안녕하세요. 계약서 작성을 시작하고 싶습니다.","timestamp":"2025-12-07T18:38:04.736729","step":"introduction"},{"text":"안녕하세요. 계약서 작성을 시작하고 싶습니다.","timestamp":"2025-12-07T18:45:18.911142","step":"work_scope"}],"provider":[]},"conflicts":[],"created_at":"2025-12-07T18:38:04.736497","updated_at":"2025-12-07T18:45:26.704649","progress_percentage":10.0} (expire: None)
12/07 18:45:28.523 DEBUG    [WS]        >> Received message: {'hd': {'event': 'chat.llm', 'role': 'client', 'timestamp': '2025-12-07T18:45:18.900749'}, 'bd': {}}
12/07 18:45:28.524 DEBUG    [WS] - Event map keys: ['doq_be']
12/07 18:45:28.524 DEBUG    [WS] - Project 'doq_be', source_type 'ws' events: ['chat.message', 'llm.invoke', 'typing']
12/07 18:45:28.524 WARNING  [WS] - No handler for event 'chat.llm'
12/07 18:45:28.524 DEBUG    [WS] - Available events: ['chat.message', 'llm.invoke', 'typing']
12/07 18:45:28.525 DEBUG    [WS]        << Send response: {'status': 'error', 'msg': 'No handler for event: chat.llm'}
12/07 18:45:28.525 DEBUG    [WS]        >> Received message: {'hd': {'event': 'chat.message', 'role': 'client', 'timestamp': '2025-12-07T18:45:18.909007'}, 'bd': {'text': '로고 디자인을 맡기려고 합니다.'}}
12/07 18:45:28.525 DEBUG    [WS] - Event map keys: ['doq_be']
12/07 18:45:28.525 DEBUG    [WS] - Project 'doq_be', source_type 'ws' events: ['chat.message', 'llm.invoke', 'typing']
12/07 18:45:28.525 DEBUG    [WS] - Dispatching to handler: src.service.ai.chat_ws.handle_llm_invocation
12/07 18:45:28.525 INFO     [WS]        -- LLM invocation (asker=client) in session reproduce_repetition_test_001
12/07 18:45:28.525 DEBUG    [WS]        -- Message: {'hd': {'event': 'chat.message', 'role': 'client', 'timestamp': '2025-12-07T18:45:18.909007', 'asker': 'client', 'sid': 'reproduce_repetition_test_001'}, 'bd': {'text': '로고 디자인을 맡기려고 합니다.'}, 'sid': 'reproduce_repetition_test_001'}
12/07 18:45:28.525 DEBUG    [WS]        -- Loaded session state for reproduce_repetition_test_001, current_step: work_scope
12/07 18:45:28.526 DEBUG    [REDIS]     ++ XADD session:chat:reproduce_repetition_test_001 > 1765100728526-0, {'participant': 'client', 'body': '{"hd":{"sid":"reproduce_repetition_test_001","event":"chat.message","role":"client"},"bd":{"text":"로고 디자인을 맡기려고 합니다."}}'}
12/07 18:45:28.526 DEBUG    [WS]        ++ Chat saved to stream session:chat:reproduce_repetition_test_001 > 1765100728526-0
12/07 18:45:28.527 INFO     [WS]        -- Chat history loaded: 8 messages
12/07 18:45:28.528 DEBUG    [WS]        -- History preview: ['assistant: 다음 단계로 이동합니다. (현재: work_scope, 진행률: 10.0%)', 'client(의뢰인(갑)): 안녕하세요. 계약서 작성을 시작하고 싶습니다.', 'assistant: \n안녕하세요, 용역 계약서 작성을 도와드릴 DoQ입니다.  \n양측 조건을 바탕으로 공정하고 명확한 계약서를 함께 만들어가겠습니다.\n\n현재 이해한 내용은 다음과 같습니다\n- 의뢰인: 의뢰인\n- 용역자: 용역자\n\n작업 범위, 기간, 대금 등을 순차적으로 확인하겠습니다.\n\n먼저 질문드릴게요: \n의뢰인님, 어떤 용역을 의뢰하실 계획인가요?  \n예: "브랜딩 로고 디자인", "웹 UI 디자인", "영상 편집 2건" 등\n']
INFO:     connection closed
12/07 18:45:29.569 INFO     [WS]        -- Step advance decision: False, reason=로고 디자인 용역이라는 것은 알았지만, 작업물의 수량, 형태, 사용 목적, 스타일, 기타 요구사항 등 구체적인 작업 범위가 아직 명확하지 않음.
12/07 18:45:36.835 DEBUG    [LLM] Response classification result: {'is_complete': True, 'extracted_data': {'work_scope': [{'type': 'design', 'description': '디자인 시안', 'quantity': 3}, {'type': 'logo design', 'description': '로고 디자인 시안', 'quantity': 2}, {'type': 'web design', 'description': '웹사이트 메인 페이지 디자인 시안', 'quantity': 1}]}, 'confidence': 0.9, 'next_action': 'proceed', 'clarification_needed': None, 'extracted_fields': {'work_scope': '디자인 시안 3개, 로고 디자인 2개, 웹사이트 메인 페이지 디자인 1개'}}
12/07 18:45:36.837 DEBUG    [WS]        -- Response classification: {'is_complete': True, 'extracted_data': {'work_scope': [{'type': 'design', 'description': '디자인 시안', 'quantity': 3}, {'type': 'logo design', 'description': '로고 디자인 시안', 'quantity': 2}, {'type': 'web design', 'description': '웹사이트 메인 페이지 디자인 시안', 'quantity': 1}]}, 'confidence': 0.9, 'next_action': 'proceed', 'clarification_needed': None, 'extracted_fields': {'work_scope': '디자인 시안 3개, 로고 디자인 2개, 웹사이트 메인 페이지 디자인 1개'}}
12/07 18:45:36.837 INFO     [WS]        -- Extracted fields saved: {'work_scope': '디자인 시안 3개, 로고 디자인 2개, 웹사이트 메인 페이지 디자인 1개'}
12/07 18:45:36.837 INFO     [WS]        -- Collected data: {"client_name":null,"client_company":null,"provider_name":null,"provider_company":null,"category":null,"work_scope":"디자인 시안 3개, 로고 디자인 2개, 웹사이트 메인 페이지
12/07 18:45:37.503 DEBUG    SYSTEM STATS - Memory 33.84MB (0.41%), CPU: 0.80%, Threads: 15, FDs: 21
12/07 18:45:38.946 DEBUG    [REDIS]     ++ XADD session:chat:reproduce_repetition_test_001 > 1765100738946-0, {'participant': 'assistant', 'body': '{"hd":{"sid":"reproduce_repetition_test_001","event":"llm.response","role":"assistant","asker":"client","step":"work_scope","user_name":"client","role_name":"client","contract_date":null},"bd":{"text":"안녕하세요, 갑(client)님. 용역 계약서 작성을 시작하겠습니다. 먼저, 이번 용역의 정확한 작업 범위를 알려주실 수 있을까요? 예를 들어, 로고 디자인의 경우, 몇 가지 시안을 제공할 예정인지, 수정 횟수는 몇 회까지 가능한지 등을 구체적으로 알려주시면 계약서 작성에 도움이 됩니다.","contract_draft":"용역 계약서 초안\\n\\n1.  용역의뢰인 (갑): client\\n2.  용역자 (을): 미기재\\n3.  용역 내용: 미기재\\n4.  계약 금액: 미기재\\n5.  계약 기간: 미기재\\n6.  저작권 귀속: 미기재\\n7.  수정 횟수: 미기재","current_step":"work_scope","progress_percentage":10.0,"state":{"code":"S0000","msg":"성공"}},"sid":"reproduce_repetition_test_001"}'}
12/07 18:45:38.946 DEBUG    [WS]        ++ Chat saved to stream session:chat:reproduce_repetition_test_001 > 1765100738946-0
12/07 18:45:38.947 INFO     [WS]        -- LLM response sent (step: work_scope, status: OK)
12/07 18:45:38.948 ERROR    [WS]        -- LLM invocation unexpected error: 
12/07 18:45:38.949 ERROR    [WS]        - Handler error: Cannot call "send" once a close message has been sent.
12/07 18:45:38.949 ERROR    [WS]        - Unexpected error: Cannot call "send" once a close message has been sent.
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/Users/eunbee/Documents/GitHub/doq-server/src/handler/websocket_handler.py", line 65, in receive_and_respond
    await websocket.send_json(response)
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/websockets.py", line 175, in send_json
    await self.send({"type": "websocket.send", "text": text})
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/websockets.py", line 97, in send
    raise RuntimeError('Cannot call "send" once a close message has been sent.')
RuntimeError: Cannot call "send" once a close message has been sent.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/applications.py", line 112, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/middleware/errors.py", line 152, in __call__
    await self.app(scope, receive, send)
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/middleware/cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/routing.py", line 362, in handle
    await self.app(scope, receive, send)
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/routing.py", line 95, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/routing.py", line 93, in app
    await func(session)
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/fastapi/routing.py", line 383, in app
    await dependant.call(**solved_result.values)
  File "/Users/eunbee/Documents/GitHub/doq-server/src/service/ai/chat_ws.py", line 92, in websocket_chat
    await ctx.ws_handler.receive_and_respond(websocket, processor=processor)
  File "/Users/eunbee/Documents/GitHub/doq-server/src/handler/websocket_handler.py", line 73, in receive_and_respond
    await websocket.send_json({
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/websockets.py", line 175, in send_json
    await self.send({"type": "websocket.send", "text": text})
  File "/Users/eunbee/Documents/GitHub/doq-server/py_env/lib/python3.11/site-packages/starlette/websockets.py", line 97, in send
    raise RuntimeError('Cannot call "send" once a close message has been sent.')
RuntimeError: Cannot call "send" once a close message has been sent.
12/07 18:45:47.508 DEBUG    SYSTEM STATS - Memory 38.72MB (0.47%), CPU: 0.60%, Threads: 15, FDs: 19
INFO:     Shutting down
INFO:     Waiting for application shutdown.
12/07 18:45:53.726 INFO          - Starting graceful shutdown
12/07 18:45:53.728 INFO          -- Shutting down application
12/07 18:45:53.728 WARNING       - RedisStreamConsumer stop failed: 'RedisStreamConsumer' object has no attribute '_consume_task'
12/07 18:45:53.728 DEBUG    [REDIS]       - Disconnecting...
12/07 18:45:53.731 ERROR    [REDIS]     !! Error while consuming stream: Connection closed by server.
12/07 18:45:53.731 WARNING  [REDIS]     >> Detected closed buffer. Attempting reconnect...
12/07 18:45:53.731 INFO     [REDIS]      -- Reconnecting to Redis...
12/07 18:45:53.731 DEBUG    [REDIS]       - Disconnecting...
12/07 18:45:53.731 INFO     [REDIS]       -- Disconnected
12/07 18:45:53.731 INFO          -- Redis handler closed
12/07 18:45:53.731 INFO     [WS]        - Disconnecting all clients...
12/07 18:45:53.732 WARNING  [WS]        - Failed to close client Address(host='127.0.0.1', port=64605): Cannot call "send" once a close message has been sent.
12/07 18:45:53.732 INFO     [WS]        - Disconnected: Client=Address(host='127.0.0.1', port=64605)
12/07 18:45:53.732 INFO          -- WebSocket handler closed
12/07 18:45:57.515 INFO     [Manager]   -- system monitor stopped
12/07 18:45:57.516 INFO          -- system monitor stopped
12/07 18:45:57.517 INFO     [REDIS]       -- Disconnected
INFO:     Application shutdown complete.
INFO:     Finished server process [32762]
INFO:     Stopping reloader process [31308]

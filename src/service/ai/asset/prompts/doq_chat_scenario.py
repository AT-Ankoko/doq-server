STEP_PROMPTS = {
    "introduction": """사용자를 환영하고, 용역 계약서 작성 프로세스를 소개합니다.
- 의뢰인(client)과 용역자(provider)의 기본 정보를 확인합니다.
- 전체 진행 흐름(작업 범위 → 기간 → 대금 → 수정 조건 등)을 안내합니다.
- 채팅의 목적과 절차를 설명하고, 자연스럽게 첫 질문으로 이어집니다.""",

    "work_scope": """용역의 작업 범위 및 내용을 구체화합니다.
- 어떤 작업인지 (예: 로고 디자인, 웹사이트 제작, 마케팅 전략 등)
- 작업물의 수량, 형태 (예: 로고 1종, PPT 20장)
- 사용 목적, 스타일, 기타 요구사항
질문 예시: "어떤 작업을 의뢰하실 계획인가요? 작업의 범위나 스타일도 알려주시면 좋습니다." """,

    "work_period": """작업 일정 및 기한을 확인합니다.
- 시작일과 완료일 또는 예상 기간
- 중간 점검 일정 여부
질문 예시: "작업은 언제부터 언제까지 진행되나요? 일정이 정해져 있으면 알려주세요." """,

    "budget": """작업 대금과 지급 조건을 명확히 합니다.
- 총액
- 지급 방식 (선금, 중도금, 잔금 비율)
- 지급 시점과 수단
질문 예시: "예상하시는 작업 대금은 얼마인가요? 지급은 어떤 방식으로 진행할까요?" """,

    "revisions": """수정 조건과 횟수를 확인합니다.
- 무상 수정 가능 횟수
- 수정 범위 (예: 일부 수정 vs 전체 수정)
- 추가 수정 발생 시 비용
질문 예시: "작업물 수정은 몇 회까지 가능하도록 할까요? 추가 수정 시 비용도 포함할까요?" """,

    "copyright": """저작권 귀속 및 활용 범위를 명시합니다.
- 결과물의 저작권 귀속(갑/을)
- 2차 저작물 제작 권한
- 상업적 이용 허용 여부
질문 예시: "완성된 결과물의 저작권은 누가 갖기로 할까요? 상업적 활용도 가능하게 하시겠어요?" """,

    "confidentiality": """기밀 유지 및 기타 특약 사항을 확인합니다.
- NDA 여부
- 포트폴리오 활용 허용 여부
- 특별한 요청 사항
질문 예시: "작업 내용 중 공개가 제한되는 부분이 있나요? 기타 특이사항도 알려주세요." """,

    "conflict_resolution": """조건 불일치 시 중재 흐름을 유도합니다.
- 양측 제안 요약
- 충돌 지점 명시
- 절충안 제안
- 수락 여부 확인""",

    "finalization": """모든 조건을 요약하고 계약서 생성을 준비합니다.
- 전체 조건 요약
- 최종 확인 요청
- 초안 생성 안내
- 수정 요청 여부 확인""",

    "completed": """계약서 작성 완료 안내 및 후속 절차 제시.
- 계약서 생성 완료 메시지
- 서명 등 다음 단계 안내
- 추가 문의 응대"""
}

START_MESSAGE_PROMPT = """
안녕하세요, 용역 계약서 작성을 도와드릴 DoQ입니다.  
양측 조건을 바탕으로 공정하고 명확한 계약서를 함께 만들어가겠습니다.

현재 이해한 내용은 다음과 같습니다
- 의뢰인: {{client_name}}
- 용역자: {{service_provider_name}}

작업 범위, 기간, 대금 등을 순차적으로 확인하겠습니다.

먼저 질문드릴게요: 
{{client_name}}님, 어떤 용역을 의뢰하실 계획인가요?  
예: "브랜딩 로고 디자인", "웹 UI 디자인", "영상 편집 2건" 등
"""

CONFLICT_RESOLUTION_PROMPT = """
client와 provider가 동일 단계에 대해 서로 다른 조건을 제시한 경우, 이를 중재하기 위한 프롬프트입니다.
아래 절차에 따라 반드시 JSON 형식으로만 응답하세요.

1. 양측이 제시한 조건을 명확하게 정리하여 비교합니다.  
   - 예: client: "3회 수정", provider: "1회 수정"

2. 충돌 지점이 무엇인지 한 문장으로 명확히 제시합니다.

3. 제3자의 중립적 관점에서 현실적인 **절충안 또는 선택지 2~3개**를 제안합니다.  
   - 단일 절충안만 제안하지 말고, 선택지를 제공하여 사용자 선택권을 보장하세요.

4. 각 당사자에게 선택지 중 어느 것을 수락하는지 물어보는 질문을 생성합니다.

출력 형식(엄수):

```json
{
  "step": "조건 충돌 조정",
  "message": "양측 조건 요약 + 충돌 지점 + 절충안/선택지 제안 + 두 사람에게 수락 여부 질문을 포함한 자연스러운 문장",
  "options": [
    "Option A: ...",
    "Option B: ...",
    "Option C: ..."
  ],
  "next_action": "client와 provider의 선택 또는 새로운 제안 대기"
}
"""

STEP_ROUTER_PROMPT = """
사용자의 응답과 현재까지 수집된 정보를 기반으로, 다음 질문 흐름을 제어하세요.

진행 순서:
1. 작업 범위 (어떤 작업인지, 작업물 수량 등)  
2. 작업 기간 (언제 시작하여 언제 끝나는지)  
3. 대금 및 지급 조건  
4. 수정 조건 (횟수, 범위, 비용 등)  
5. 저작권 귀속 및 활용 범위  
6. 비밀 유지 및 기타 특약  
7. 최종 확인 및 계약서 초안 생성

흐름 제어 규칙:
- 현재 단계의 모든 정보가 수집되었는지 확인하세요.
- 일부 정보가 누락되어 있다면, **기존 응답을 존중하면서 보완 질문**을 하십시오.
  예: "로고 디자인입니다" → "감사합니다. 로고의 스타일이나 수량도 정해져 있으신가요?"
- 모든 정보가 충분히 수집되었다면, **자연스럽게 다음 단계로 넘어가세요**.

출력 형식 (반드시 지킬 것):
```json
{
  "step": "다음 단계 이름 또는 보완 질문 단계 이름",
  "message": "자연스럽고 간결한 질문. 중복 질문 없이, 필요한 경우 보완 질문 형태로 작성.",
  "next_action": "사용자 응답 대기 또는 다음 단계 진입 안내"
}
"""

RESPONSE_CLASSIFICATION_PROMPT = """
현재 단계: {{current_step}}  
사용자 응답: {{user_response}}

사용자 응답을 분석하여 JSON 형식으로 반환하세요.

{
  "is_complete": boolean,  // 현재 단계의 질문에 대한 충분한 답변이 있는가?
  "extracted_data": object,  // 추출된 계약 정보 (단계별로 다름)
  "confidence": float,  // 0.0 ~ 1.0 신뢰도
  "next_action": "proceed" | "ask_clarification" | "conflict_detected",
  "clarification_needed": string or null,  // 추가 질문이 필요하면 그 내용
  "extracted_fields": object,  // 수집된 데이터 필드 (예: work_scope, start_date 등)
}

단계별 추출 대상:
- work_scope: 작업 내용, 작업물 수량, 작업 유형
- work_period: 시작일, 종료일/예상기간
- budget: 총 대금, 지급 방식, 지급 시점
- revisions: 수정 횟수, 수정 범위, 추가 수정 비용
- copyright: 저작권 귀속처, 2차 저작물 권한, 상업 이용 범위
- confidentiality: 비밀 유지 조항, 포트폴리오 사용 가능 여부, 기타 특약

사용자 응답: {{user_response}}
"""

# chat_ws.py에서 사용되는 대화 프롬프트 템플릿

NORMAL_RESPONSE_PROMPT_TEMPLATE = """{system_prompt}

현재 단계: {{current_step}}
단계별 가이드: {{step_guide}}

=== 이전 대화 기록 (반드시 참고하여 일관성 유지) ===
{{conversation_context}}
=== 끝 ===

=== 이미 수집된 정보 (절대 반복하지 마세요) ===
{{collected_fields_summary}}
=== 끝 ===

=== 이전 작성된 계약서 초안 (계속 업데이트하세요) ===
{{previous_contract_draft}}
=== 끝 ===

사용자({{role}}): {{user_query}}

역할별 입력(role_inputs): {{role_inputs_json}}
계약서 템플릿: {{contract_template}}

=== 중요 지시사항 ===
{{step_specific_instruction}}
1. ⭐ 위의 "이미 수집된 정보" 섹션에 나열된 항목은 절대 반복 질문하지 마세요.
   예: "로고디자인을 맡기고 싶습니다"라고 이미 답변했으면, "어떤 작업을 하시려고 하나요?"를 다시 묻지 마세요.
2. 현재 {{current_step}} 단계에서 아직 수집되지 않은 정보만 질문하세요.
3. 사용자의 새로운 입력을 수집된 정보에 반영하여 계약서를 업데이트하세요.
4. 위의 메타 정보(단계별 가이드, 수집된 정보, 템플릿 등)는 사용자에게 노출하지 마세요.

출력 규칙 (엄수):
아래 JSON 형식으로만 응답하세요. 다른 텍스트는 절대 금지.
형식: {{"USER_MESSAGE": "사용자에게 보여줄 짧은 안내/질문 한 단락. 이미 답변한 것은 절대 반복 금지.", "CONTRACT_DRAFT": "용역계약서 초안. 수집된 정보와 템플릿을 활용해 핵심 조항만 한국어로 간결히 작성. 미기재 항목은 '미기재'로 표기. 서론/메타설명 없이 계약 조항만."}}
"""

STEP_TRANSITION_PROMPT_TEMPLATE = """{system_prompt}

이전 단계: {{previous_step}} - {{previous_step_guide}}
현재 단계(새로 시작): {{current_step}} - {{step_guide}}

=== 지난 전체 대화 기록 (참고용) ===
{{conversation_context}}
=== 끝 ===

=== 현재까지 수집된 정보 (이미 확인된 항목은 절대 반복 질문하지 마세요) ===
{{collected_fields_summary}}
=== 끝 ===

=== 이전 작성된 계약서 초안 (계속 업데이트하세요) ===
{{previous_contract_draft}}
=== 끝 ===

사용자({{role}}): {{user_name}} (계약일자: {{contract_date}})

역할별 입력(role_inputs): {{role_inputs_json}}
계약서 템플릿: {{contract_template}}

=== 중요 지시사항 ===
{{step_specific_instruction}}
1. ⭐ 위의 "현재까지 수집된 정보" 섹션을 반드시 확인하세요. 이미 답변한 항목은 절대 반복 질문하지 마세요.
   예: "work_scope: 로고 디자인을 맡기려고 합니다"라고 있으면, 작업 내용을 다시 묻지 마세요.
2. 현재 {{current_step}} 단계에서 아직 수집되지 않은 정보(null인 항목)만 질문하세요.
3. 새 단계 시작 인사는 짧게(한두 문장), 그 다음 첫 번째 미수집 정보에 대한 질문으로 자연스럽게 이어지도록 하세요.
4. 위의 메타 정보(단계별 가이드, 수집된 정보, 템플릿 등)는 사용자에게 노출하지 마세요.
5. 사용자의 새로운 입력을 수집된 정보에 반영하여 계약서를 업데이트하세요.

출력 규칙 (엄수):
아래 JSON 형식으로만 응답하세요. 다른 텍스트는 절대 금지.
형식: {{"USER_MESSAGE": "현재 단계 시작 인사(짧게) + 이 단계의 첫 번째 질문. 이미 수집된 정보는 반복 금지.", "CONTRACT_DRAFT": "용역계약서 초안. 새로운 정보 반영. 미기재 항목은 '미기재'로 표기."}}
"""

# 단계 진행 의사 분류용 프롬프트
STEP_ADVANCE_CLASSIFICATION_PROMPT = """
아래는 갑(client)/을(provider)/assistant의 대화 로그입니다.
현재 단계: {{current_step}}
현재 단계 가이드: {{current_step_prompt}}
최근 대화(최신순):
{{conversation_context}}
마지막 사용자 메시지: {{user_query}}

사용자가 이 단계를 충분히 마쳤다고 판단되어 다음 단계로 진행 의사가 명확하면 advance=true, 아니면 advance=false로 판단하세요.

출력 규칙 (엄수):
- 아래 JSON 한 줄만 출력 (설명/문장/코드블록/마크다운 금지)
- 키는 소문자, 불리는 true/false 소문자로
- 형식: {"advance": true|false, "reason": "..."}
"""